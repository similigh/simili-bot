# =============================================================================
# E2E Integration Test Pipeline for Simili Bot
# =============================================================================
# Triggers on every PR to main. Creates a temporary test repo under the bot
# user account, seeds it with issues, installs the PR version of Simili,
# then verifies duplicate detection and loop safety.
#
# Required secrets:
#   BOT_PAT          - Bot user PAT (repo, workflow, delete_repo scopes)
#   BOT_USERNAME     - Bot user's GitHub username
#   QDRANT_URL       - Qdrant cluster URL
#   QDRANT_API_KEY   - Qdrant API key
#   GEMINI_API_KEY   - Gemini API key
# =============================================================================

name: Simili E2E Test

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  # Unique names per workflow run to avoid collisions
  TEST_REPO_NAME: "simili-e2e-${{ github.run_id }}"
  TEST_COLLECTION: "simili-e2e-test-${{ github.run_id }}"

jobs:
  e2e-test:
    name: E2E Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # -----------------------------------------------------------------------
      # 0. Validate Secrets ‚Äî Fail early if required secrets are missing
      # -----------------------------------------------------------------------
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.BOT_PAT }}" ]; then
            echo "::error::BOT_PAT secret is missing! Please add it to Settings -> Secrets and variables -> Actions."
            exit 1
          fi
          if [ -z "${{ secrets.BOT_USERNAME }}" ]; then
            echo "::error::BOT_USERNAME secret is missing! Please add it to Settings -> Secrets and variables -> Actions."
            exit 1
          fi
          echo "‚úÖ Required secrets are present."

      # -----------------------------------------------------------------------
      # 1. Setup ‚Äî Create temporary test repository (PUBLIC so devs can inspect)
      # -----------------------------------------------------------------------
      - name: Create test repository
        run: |
          echo "::group::Authenticating as bot user"
          echo "${{ secrets.BOT_PAT }}" | gh auth login --with-token
          gh auth status
          echo "::endgroup::"

          echo "::group::Creating test repo ${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          gh repo create "${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}" \
            --public \
            --description "Simili E2E test repo (auto-created by PR #${{ github.event.pull_request.number }})" \
            --clone
          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 2. Seed ‚Äî Push README and simili.yaml config (NO workflow yet)
      # -----------------------------------------------------------------------
      - name: Seed test repository with config files
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          set -x
          cd "${{ env.TEST_REPO_NAME }}"

          # Set up authentication for git push using gh CLI
          unset GH_TOKEN
          echo "${{ secrets.BOT_PAT }}" | gh auth login --with-token
          gh auth setup-git

          # Configure user identity
          git config user.name "${{ secrets.BOT_USERNAME }}"
          git config user.email "makerslab.foss@gmail.com"

          # --- README ---
          cat > README.md << 'README_EOF'
# Simili E2E Test Repository

This repository is automatically created by the Simili Bot E2E test pipeline.
It is kept alive so developers can inspect the results.
README_EOF

          # --- .github/simili.yaml ---
          mkdir -p .github
          cat > .github/simili.yaml << EOF
qdrant:
  url: "${QDRANT_URL}"
  api_key: "${QDRANT_API_KEY}"
  collection: "${{ env.TEST_COLLECTION }}"

embedding:
  provider: "gemini"
  api_key: "${GEMINI_API_KEY}"
  model: "gemini-embedding-001"
  dimensions: 3072

llm:
  provider: "gemini"
  api_key: "${GEMINI_API_KEY}"
  model: "gemini-2.5-flash"

defaults:
  similarity_threshold: 0.65
  max_similar_to_show: 3

bot_users:
  - "${{ secrets.BOT_USERNAME }}"
EOF

          # Commit and push
          git add -A
          git commit -m "chore: seed E2E test repo with Simili config"
          git push origin HEAD:main

      # -----------------------------------------------------------------------
      # 3. Copy secrets to test repo (so its workflows can use them)
      # -----------------------------------------------------------------------
      - name: Set secrets on test repository
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          echo "::group::Setting secrets on $REPO"
          echo "${{ secrets.QDRANT_URL }}" | gh secret set QDRANT_URL --repo "$REPO"
          echo "${{ secrets.QDRANT_API_KEY }}" | gh secret set QDRANT_API_KEY --repo "$REPO"
          echo "${{ secrets.GEMINI_API_KEY }}" | gh secret set GEMINI_API_KEY --repo "$REPO"
          echo "${{ secrets.BOT_PAT }}" | gh secret set GH_PAT --repo "$REPO"
          echo "${{ secrets.BOT_USERNAME }}" | gh secret set BOT_USERNAME --repo "$REPO"
          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 4. Create 5 seed issues (NO workflow yet, so these won't trigger the bot)
      # -----------------------------------------------------------------------
      - name: Create seed issues
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"

          echo "::group::Creating 5 seed issues"

          gh issue create --repo "$REPO" \
            --title "App crashes on login with invalid credentials" \
            --body "When entering a wrong password, the application crashes with an unhandled exception instead of displaying a user-friendly error message. Steps to reproduce: 1. Open the app 2. Enter valid username 3. Enter incorrect password 4. Click login. Expected: Error message. Actual: App crashes."

          gh issue create --repo "$REPO" \
            --title "Add dark mode support" \
            --body "Users have requested a dark mode theme for better readability in low-light environments. This should include a toggle in settings and automatic detection of system preferences."

          gh issue create --repo "$REPO" \
            --title "Performance degradation on large datasets" \
            --body "Loading time exceeds 30 seconds when the dataset has more than 10,000 rows. The UI becomes unresponsive during data loading. We need pagination or virtual scrolling."

          gh issue create --repo "$REPO" \
            --title "Update documentation for API v2" \
            --body "Current documentation still references deprecated API v1 endpoints. All examples, curl commands, and SDK snippets need to be updated to reflect the v2 API changes."

          gh issue create --repo "$REPO" \
            --title "Mobile responsive layout broken on iOS Safari" \
            --body "The navigation menu overlaps with the main content area on iPhone 12 and below when using Safari. The hamburger menu does not collapse properly after selecting a menu item."

          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 5. Index the seed issues into Qdrant
      # -----------------------------------------------------------------------
      - name: Checkout simili-bot (PR version)
        uses: actions/checkout@v4
        with:
          path: simili-bot-src

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build simili CLI from PR
        run: |
          cd simili-bot-src
          go build -o /tmp/simili-cli ./cmd/simili/main.go

      - name: Index seed issues
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"

          # Create a temporary config for the CLI
          cat > /tmp/simili-index-config.yaml << EOF
          qdrant:
            url: "${QDRANT_URL}"
            api_key: "${QDRANT_API_KEY}"
            collection: "${{ env.TEST_COLLECTION }}"

          embedding:
            provider: "gemini"
            api_key: "${GEMINI_API_KEY}"
            model: "gemini-embedding-001"
            dimensions: 3072

          llm:
            provider: "gemini"
            api_key: "${GEMINI_API_KEY}"
            model: "gemini-2.5-flash"
          EOF

          echo "::group::Indexing seed issues"
          /tmp/simili-cli index \
            --repo "$REPO" \
            --config /tmp/simili-index-config.yaml \
            --workers 2
          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 6. Wait for indexing to settle
      # -----------------------------------------------------------------------
      - name: Wait for index to settle
        run: sleep 15

      # -----------------------------------------------------------------------
      # 7. Enable Workflow ‚Äî NOW add triage.yml so only future issues trigger it
      # -----------------------------------------------------------------------
      - name: Enable Simili workflow
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          set -x
          rm -rf "${{ env.TEST_REPO_NAME }}_workflow"
          echo "::group::Cloning test repo to add workflow"
          gh repo clone "${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}" "${{ env.TEST_REPO_NAME }}_workflow"
          cd "${{ env.TEST_REPO_NAME }}_workflow"
          echo "::endgroup::"

          # Set up authentication for git push using gh CLI
          unset GH_TOKEN
          echo "${{ secrets.BOT_PAT }}" | gh auth login --with-token
          gh auth setup-git

          # Configure user identity
          git config user.name "${{ secrets.BOT_USERNAME }}"
          git config user.email "makerslab.foss@gmail.com"

          # --- .github/workflows/triage.yml ---
          # Write the workflow file WITHOUT extra leading whitespace
          mkdir -p .github/workflows
          cat > .github/workflows/triage.yml << 'WORKFLOW_EOF'
name: Simili Triage

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run Simili Bot
        uses: similigh/simili-bot@__PR_SHA__
        env:
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SIMILI_E2E_TEST_USER: ${{ secrets.BOT_USERNAME }}
        with:
          config_path: .github/simili.yaml
          command: process
          github_token: ${{ secrets.GH_PAT }}
WORKFLOW_EOF

          # Replace the placeholder with the actual PR SHA
          sed -i "s|__PR_SHA__|${{ github.event.pull_request.head.sha }}|g" .github/workflows/triage.yml

          # Commit and push
          git add -A
          git commit -m "chore: enable Simili Triage workflow"
          git push origin HEAD:main

          echo "Sleeping for 15 seconds to allow GitHub to register the new workflow..."
          sleep 15

      # -----------------------------------------------------------------------
      # 8. Create trigger issue (designed to match seed issue #1)
      # -----------------------------------------------------------------------
      - name: Create trigger issue
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"

          ISSUE_URL=$(gh issue create --repo "$REPO" \
            --title "Application crashes when logging in with wrong password" \
            --body "The application throws an unhandled exception when invalid credentials are entered during the login flow. The crash occurs immediately after clicking the submit button. No error dialog is shown to the user.")

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Trigger issue created: #$ISSUE_NUMBER"

      # -----------------------------------------------------------------------
      # 9. Poll for bot response on the trigger issue
      # -----------------------------------------------------------------------
      - name: Wait for bot response
        id: poll
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          ISSUE_NUMBER="${{ steps.trigger.outputs.issue_number }}"
          BOT_USER="${{ secrets.BOT_USERNAME }}"

          echo "Polling for bot response on issue #$ISSUE_NUMBER..."
          MAX_ATTEMPTS=30  # 30 x 10s = 5 minutes
          ATTEMPT=0
          BOT_COMMENTED="false"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Check for comments by the bot user
            COMMENTS=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments" \
              --jq "[.[] | select(.user.login == \"$BOT_USER\")] | length")

            if [ "$COMMENTS" -gt 0 ]; then
              echo "‚úÖ Bot commented on issue #$ISSUE_NUMBER!"
              BOT_COMMENTED="true"

              # Capture the comment body for verification
              COMMENT_BODY=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments" \
                --jq "[.[] | select(.user.login == \"$BOT_USER\")][0].body")
              echo "Bot comment body:"
              echo "$COMMENT_BODY"
              echo "comment_body<<COMMENT_EOF" >> "$GITHUB_OUTPUT"
              echo "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
              echo "COMMENT_EOF" >> "$GITHUB_OUTPUT"
              break
            fi

            sleep 10
          done

          echo "bot_commented=$BOT_COMMENTED" >> "$GITHUB_OUTPUT"

          if [ "$BOT_COMMENTED" = "false" ]; then
            echo "‚ùå Bot did not respond within 5 minutes"

            # Check if the workflow even ran in the test repo
            echo "--- Checking workflow runs in test repo ---"
            gh run list --repo "$REPO" --limit 5 || true
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 10. Verify similarity detection
      # -----------------------------------------------------------------------
      - name: Verify similarity detection
        if: steps.poll.outputs.bot_commented == 'true'
        run: |
          COMMENT_BODY='${{ steps.poll.outputs.comment_body }}'

          echo "::group::Checking similarity detection"
          # The bot should have found the similar seed issue about login crashes
          if echo "$COMMENT_BODY" | grep -qiE "(similar|duplicate|related|#1|crash.*login|login.*crash)"; then
            echo "‚úÖ Bot detected similarity correctly!"
          else
            echo "‚ö†Ô∏è Bot responded but similarity reference not found in comment."
            echo "This may indicate the similarity threshold needs tuning."
            echo "Comment body was: $COMMENT_BODY"
          fi
          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 11. Loop detection ‚Äî Verify the bot didn't trigger itself
      # -----------------------------------------------------------------------
      - name: Verify no infinite loop
        if: steps.poll.outputs.bot_commented == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          ISSUE_NUMBER="${{ steps.trigger.outputs.issue_number }}"
          BOT_USER="${{ secrets.BOT_USERNAME }}"

          echo "Waiting 60s for any re-triggered workflow runs..."
          sleep 60

          echo "::group::Loop detection check"

          # Count bot comments on the trigger issue
          BOT_COMMENT_COUNT=$(gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            --jq "[.[] | select(.user.login == \"$BOT_USER\")] | length")

          echo "Bot comments on trigger issue: $BOT_COMMENT_COUNT"

          if [ "$BOT_COMMENT_COUNT" -gt 1 ]; then
            echo "‚ùå LOOP DETECTED: Bot commented $BOT_COMMENT_COUNT times on the trigger issue!"
            echo "This indicates the bot's own comment re-triggered the workflow."
            exit 1
          fi

          echo "‚úÖ No loop detected ‚Äî bot commented exactly once."
          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 12. Cleanup Qdrant collection (always run)
      # -----------------------------------------------------------------------
      - name: Cleanup Qdrant collection
        if: always()
        run: |
          echo "::group::Deleting Qdrant test collection"

          # Delete the test collection via Qdrant REST API
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            "${{ secrets.QDRANT_URL }}/collections/${{ env.TEST_COLLECTION }}" \
            -H "api-key: ${{ secrets.QDRANT_API_KEY }}" \
            -H "Content-Type: application/json")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "‚úÖ Test collection cleaned up (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Unexpected response when deleting collection: HTTP $RESPONSE"
          fi

          echo "::endgroup::"

      # -----------------------------------------------------------------------
      # 13. Update test repo README with results and post PR comment
      # -----------------------------------------------------------------------
      - name: Update test repo with results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          BOT_COMMENTED="${{ steps.poll.outputs.bot_commented }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"
          RUN_ID="${{ github.run_id }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${RUN_ID}"

          # Update README with test results
          rm -rf "${{ env.TEST_REPO_NAME }}_results"
          gh repo clone "$REPO" "${{ env.TEST_REPO_NAME }}_results" || true
          cd "${{ env.TEST_REPO_NAME }}_results" || exit 0

          unset GH_TOKEN
          echo "${{ secrets.BOT_PAT }}" | gh auth login --with-token
          gh auth setup-git
          git config user.name "${{ secrets.BOT_USERNAME }}"
          git config user.email "makerslab.foss@gmail.com"

          cat > README.md << EOF
# Simili E2E Test Repository

> Auto-created by [PR #${PR_NUMBER}](https://github.com/${{ github.repository }}/pull/${PR_NUMBER}) E2E test run

## Test Results

| Detail | Value |
|--------|-------|
| **PR** | [#${PR_NUMBER}](https://github.com/${{ github.repository }}/pull/${PR_NUMBER}) |
| **Commit** | \`${PR_SHA:0:7}\` |
| **Run** | [#${RUN_ID}](${RUN_URL}) |
| **Bot Responded** | $([ "$BOT_COMMENTED" = "true" ] && echo "‚úÖ Yes" || echo "‚ùå No") |
| **Created** | $(date -u '+%Y-%m-%d %H:%M UTC') |

## What this repo tests

1. **Seed issues** (#1-#5) ‚Äî diverse issues for the similarity corpus
2. **Trigger issue** (#6) ‚Äî designed to match seed issue #1 (login crash)
3. **Bot response** ‚Äî verifies the bot detects the duplicate and posts a triage comment
4. **Loop safety** ‚Äî verifies the bot doesn't re-trigger itself
EOF

          git add -A
          git diff --cached --quiet || {
            git commit -m "chore: update README with E2E test results"
            git push origin HEAD:main
          }

      - name: Post PR comment with test repo link
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}"
          BOT_COMMENTED="${{ steps.poll.outputs.bot_commented }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          RESULT_EMOJI=$([ "$BOT_COMMENTED" = "true" ] && echo "‚úÖ" || echo "‚ùå")

          gh pr comment "$PR_NUMBER" --body "## üß™ E2E Test Results

${RESULT_EMOJI} **Bot Response:** $([ "$BOT_COMMENTED" = "true" ] && echo "Bot detected duplicate and posted triage comment" || echo "Bot did not respond within timeout")

**Test Repo:** [${REPO}](https://github.com/${REPO}) ‚Äî inspect issues, comments, and workflow runs
**Workflow Run:** [View logs](${RUN_URL})

<sub>Auto-generated by E2E test pipeline</sub>"

      # -----------------------------------------------------------------------
      # 14. Summary
      # -----------------------------------------------------------------------
      - name: Test summary
        if: always()
        run: |
          echo "## E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Repo Created | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.poll.outputs.bot_commented }}" = "true" ]; then
            echo "| Bot Responded | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Bot Responded | ‚ùå |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Test Repo | [${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}](https://github.com/${{ secrets.BOT_USERNAME }}/${{ env.TEST_REPO_NAME }}) |" >> $GITHUB_STEP_SUMMARY
